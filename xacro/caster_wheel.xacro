<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Xacro properties for caster wheel dimensions -->
  <xacro:property name="caster_ball_radius" value="0.025"/>
  <xacro:property name="caster_cylinder_radius" value="0.005"/>
  <xacro:property name="caster_cylinder_length" value="0.001"/>

  <!-- Masses -->
  <xacro:property name="caster_cylinder_mass" value="0.001"/>
  <xacro:property name="caster_ball_mass" value="0.001"/>

  <!-- Caster Wheel Macro -->
  <xacro:macro name="caster_wheel" params="prefix parent_link *origin">

    <!-- Yaw Link -->
    <link name="${prefix}_yaw_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <geometry>
          <cylinder radius="${caster_cylinder_radius}" length="${caster_cylinder_length}"/>
        </geometry>
        <material name="blue"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <geometry>
          <cylinder radius="${caster_cylinder_radius}" length="${caster_cylinder_length}"/>
        </geometry>
      </collision>

      <inertial>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <mass value="${caster_cylinder_mass}"/>
        <!-- Cylinder inertia: Ixx = Iyy = (1/12)*m*(3*r^2 + h^2), Izz = (1/2)*m*r^2 -->
        <inertia ixx="${(1/12) * caster_cylinder_mass * (3 * caster_cylinder_radius * caster_cylinder_radius + caster_cylinder_length * caster_cylinder_length)}" ixy="0.0" ixz="0.0" iyy="${(1/12) * caster_cylinder_mass * (3 * caster_cylinder_radius * caster_cylinder_radius + caster_cylinder_length * caster_cylinder_length)}" iyz="0.0" izz="${(1/2) * caster_cylinder_mass * caster_cylinder_radius * caster_cylinder_radius}"/>
      </inertial>
    </link>

    <!-- Yaw Joint -->
    <joint name="${prefix}_yaw_joint" type="continuous">
      <xacro:insert_block name="origin"/>
      <parent link="${parent_link}"/>
      <child link="${prefix}_yaw_link"/>
      <axis xyz="0 0 1"/>
      <limit effort="1000.0" velocity="100.0"/>
      <dynamics damping="0.0" friction="0.1"/>
    </joint>

    <!-- Roll Link -->
    <link name="${prefix}_roll_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <geometry>
          <cylinder radius="${caster_cylinder_radius}" length="${caster_cylinder_length}"/>
        </geometry>
        <material name="red"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <geometry>
          <cylinder radius="${caster_cylinder_radius}" length="${caster_cylinder_length}"/>
        </geometry>
      </collision>

      <inertial>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <mass value="${caster_cylinder_mass}"/>
        <!-- Cylinder inertia: Ixx = Iyy = (1/12)*m*(3*r^2 + h^2), Izz = (1/2)*m*r^2 -->
        <inertia ixx="${(1/12) * caster_cylinder_mass * (3 * caster_cylinder_radius * caster_cylinder_radius + caster_cylinder_length * caster_cylinder_length)}" ixy="0.0" ixz="0.0" iyy="${(1/12) * caster_cylinder_mass * (3 * caster_cylinder_radius * caster_cylinder_radius + caster_cylinder_length * caster_cylinder_length)}" iyz="0.0" izz="${(1/2) * caster_cylinder_mass * caster_cylinder_radius * caster_cylinder_radius}"/>
      </inertial>
    </link>

    <!-- Roll Joint -->
    <joint name="${prefix}_roll_joint" type="continuous">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="${prefix}_yaw_link"/>
      <child link="${prefix}_roll_link"/>
      <axis xyz="1 0 0"/>
      <limit effort="1000.0" velocity="100.0"/>
      <dynamics damping="0.0" friction="0.1"/>
    </joint>

    <!-- Pitch Link (ball) -->
    <link name="${prefix}_pitch_link">
      <visual>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <geometry>
          <sphere radius="${caster_ball_radius}"/>
        </geometry>
        <material name="black"/>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <geometry>
          <sphere radius="${caster_ball_radius}"/>
        </geometry>
      </collision>

      <inertial>
        <origin xyz="0 0 0" rpy="0 1.5707 1.5707"/>
        <mass value="${caster_ball_mass}"/>
        <!-- Sphere inertia: I = (2/5)*m*r^2 -->
        <inertia ixx="${(2/5) * caster_ball_mass * caster_ball_radius * caster_ball_radius}" ixy="0.0" ixz="0.0" iyy="${(2/5) * caster_ball_mass * caster_ball_radius * caster_ball_radius}" iyz="0.0" izz="${(2/5) * caster_ball_mass * caster_ball_radius * caster_ball_radius}"/>
      </inertial>
    </link>

    <!-- Pitch Joint -->
    <joint name="${prefix}_pitch_joint" type="continuous">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="${prefix}_roll_link"/>
      <child link="${prefix}_pitch_link"/>
      <axis xyz="0 1 0"/>
      <limit effort="1000.0" velocity="100.0"/>
      <dynamics damping="0.0" friction="0.1"/>
    </joint>

    <!-- Gazebo Properties -->
    <gazebo reference="${prefix}_yaw_link">
      <material>Gazebo/Blue</material>
    </gazebo>

    <gazebo reference="${prefix}_roll_link">
      <material>Gazebo/Red</material>
    </gazebo>

    <gazebo reference="${prefix}_pitch_link">
      <material>Gazebo/Black</material>
      <kp>1000000000000000000000000000.0</kp>
      <kd>1000000000000000000000000000.0</kd>
      <mu1>0.5</mu1>
      <mu2>0.5</mu2>
    </gazebo>

  </xacro:macro>

</robot>
